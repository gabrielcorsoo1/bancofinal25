@model IEnumerable<AtlasAir.Models.Seat>
@{
    var flight = ViewData["Flight"] as AtlasAir.Models.Flight;
    ViewData["Title"] = $"Assentos disponíveis - Voo {flight?.Id}";
}

<h2>Assentos disponíveis - Voo @flight?.Id</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

@if (!Model.Any())
{
    <p>Nenhum assento disponível.</p>
    <a asp-action="Search" class="btn btn-link">Voltar</a>
}
else
{
    <form asp-action="Purchase" method="post" id="purchaseForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="flightId" value="@flight?.Id" />
        <div class="row g-2">
            @foreach (var s in Model)
            {
                <div class="col-auto">
                    <div class="card p-2">
                        <div>@s.SeatNumber (@s.Class)</div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-success select-seat" data-seat="@s.Id">Selecionar</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="mt-4">
            <input type="hidden" id="selectedSeat" name="seatId" />
            <button type="submit" class="btn btn-primary" id="btnBuy" disabled>Comprar</button>

            <!-- Botão de reserva rápida -->
            <form id="quickReserveForm" method="post" style="display:inline;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="flightId" value="@flight?.Id" />
                <button type="button" class="btn btn-outline-primary" id="btnQuickReserve">Reservar Rápido</button>
            </form>

            <span id="quickActionContainer" class="ms-3"></span>

            <a asp-action="Search" class="btn btn-link">Voltar</a>
        </div>
    </form>
}

@section Scripts {
    <script>
        // seleção manual
        document.querySelectorAll('.select-seat').forEach(function (btn) {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.select-seat').forEach(b => b.classList.remove('btn-success'));
                document.querySelectorAll('.select-seat').forEach(b => b.classList.add('btn-outline-success'));
                this.classList.remove('btn-outline-success');
                this.classList.add('btn-success');

                var seatId = this.getAttribute('data-seat');
                document.getElementById('selectedSeat').value = seatId;
                document.getElementById('btnBuy').disabled = false;
            });
        });

        document.getElementById('purchaseForm')?.addEventListener('submit', function (e) {
            var seatId = document.getElementById('selectedSeat').value;
            if (!seatId) { e.preventDefault(); alert('Selecione um assento.'); }
        });

        // reservar rápido (servidor escolhe assento aleatório entre disponíveis)
        (function () {
            var btn = document.getElementById('btnQuickReserve');
            if (!btn) return;

            btn.addEventListener('click', function () {
                var form = document.getElementById('quickReserveForm');
                var fd = new FormData(form);

                // extrai token antiforgery do form
                var token = form.querySelector('input[name="__RequestVerificationToken"]')?.value;

                fetch('@Url.Action("QuickReserve", "Client")', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    body: fd
                })
                .then(r => r.json())
                .then(data => {
                    if (data.needsLogin) {
                        window.location.href = data.redirect;
                        return;
                    }
                    if (!data.success) {
                        alert(data.message || 'Erro ao tentar reservar.');
                        return;
                    }

                    // mostra sucesso e cria botão de cancelar reservado
                    var container = document.getElementById('quickActionContainer');
                    container.innerHTML = '';

                    var msg = document.createElement('div');
                    msg.className = 'alert alert-success d-inline-block me-2';
                    msg.innerText = 'Reserva feita: Assento ' + data.seatNumber + ' (Código: ' + data.reservationCode + ')';
                    container.appendChild(msg);

                    var cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-outline-danger';
                    cancelBtn.type = 'button';
                    cancelBtn.innerText = 'Cancelar Reserva';
                    cancelBtn.dataset.reservationId = data.reservationId;
                    container.appendChild(cancelBtn);

                    // desabilita seleção e compra direta
                    btn.disabled = true;
                    document.getElementById('btnBuy').disabled = true;
                    document.querySelectorAll('.select-seat').forEach(b => b.disabled = true);

                    // cancelar reserva via AJAX
                    cancelBtn.addEventListener('click', function () {
                        var reservationId = this.dataset.reservationId;
                        var formData = new FormData();
                        formData.append('reservationId', reservationId);

                        fetch('@Url.Action("CancelReservation", "Client")', {
                            method: 'POST',
                            headers: {
                                'RequestVerificationToken': token
                            },
                            body: formData
                        })
                        .then(r => r.json())
                        .then(resp => {
                            if (!resp.success) {
                                alert(resp.message || 'Erro ao cancelar reserva.');
                                return;
                            }

                            // atualiza UI
                            container.innerHTML = '<div class="alert alert-info">Reserva cancelada com sucesso.</div>';
                            cancelBtn.disabled = true;
                        })
                        .catch(() => alert('Erro de comunicação.'));
                    });
                })
                .catch(() => alert('Erro de comunicação.'));
            });
        })();
    </script>
}